name: PR Metadata Validator
on:
  workflow_call:
    inputs:
      accepted_categories:
        description: 'List of accepted categories (comma-separated)'
        type: string
        default: 'FO, CO, BO, WS, IN, TE, LO, ME, PM'
      accepted_types:
        description: 'List of accepted types (comma-separated)'
        type: string
        default: 'bug fix, improvement, refacto, new feature'

jobs:
  validate:
    name: Validate PR Metadata
    runs-on: ubuntu-latest
    steps:
      - name: Check PR Metadata
        uses: actions/github-script@v7
        env:
          # Pass inputs via env variables for security and ease of access in JS
          ACCEPTED_CATEGORIES: ${{ inputs.accepted_categories }}
          ACCEPTED_TYPES: ${{ inputs.accepted_types }}
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title;
            const body = pr.body || "";
            const author = pr.user.login;
            const milestone = pr.milestone ? pr.milestone.title : "";

            const categories = process.env.ACCEPTED_CATEGORIES.split(',').map(s => s.trim().toUpperCase());
            const types = process.env.ACCEPTED_TYPES.split(',').map(s => s.trim().toLowerCase());
            
            const BUMP_PR_AUTHOR = ['dependabot[bot]', 'github-actions[bot]'];
            const BUMP_PR_TITLE_PREFIX = 'Bump';

            // Bypass validation for automated dependency updates (bots)
            if (title.startsWith(BUMP_PR_TITLE_PREFIX) && BUMP_PR_AUTHOR.includes(author)) {
              console.log("Bump PR detected. Skipping metadata validation.");
              return;
            }

            const errors = [];

            /**
             * Regex Helper
             * Captures the content of a table cell or a list item.
             * Matches: "| Category | FO |" or "Category: FO"
             * Captures everything until the next pipe (|) or newline (\n)
             */
            function buildPattern(propertyName) {
              // Note: Double backslashes (\\) are required for the String-to-RegExp constructor
              return new RegExp('^\\s*\\|?\\s*' + propertyName + '\\??\\s*[:|]\\s*([^|\\n]+)', 'im');
            }

            // 1. Validate Category
            const categoryMatch = body.match(buildPattern('Category'));
            const categoryRaw = categoryMatch ? categoryMatch[1].trim().toUpperCase() : "";

            if (!categories.includes(categoryRaw)) {
              errors.push(`Invalid Category: "${categoryRaw || 'not found'}". You must choose exactly one from: ${categories.join(', ')}`);
            }

            // 2. Validate Type
            const typeMatch = body.match(buildPattern('Type'));
            const typeRaw = typeMatch ? typeMatch[1].trim().toLowerCase() : "";

            if (!types.includes(typeRaw)) {
              errors.push(`Invalid Type: "${typeRaw || 'not found'}". You must choose exactly one from: ${types.join(', ')}`);
            }

            // 3. Validate Title (Must start with an uppercase letter)
            if (!/^[A-Z]/.test(title)) {
              errors.push('Pull Request title must start with an uppercase letter');
            }

            // 4. Validate Milestone
            if (!milestone) {
              errors.push('No milestone defined for this Pull Request');
            }

            // Final Evaluation
            if (errors.length > 0) {
              core.setFailed("PR Metadata Validation Failed:\n- " + errors.join('\n- '));
            } else {
              console.log("PR Metadata Validation Successful!");
            }
