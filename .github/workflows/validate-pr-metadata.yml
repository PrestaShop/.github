name: PR Metadata Validator
on:
  workflow_call:
    inputs:
      accepted_categories:
        description: 'List of accepted categories (comma-separated)'
        type: string
        default: 'FO, CO, BO, WS, IN, TE, LO, ME, PM'
      accepted_types:
        description: 'List of accepted types (comma-separated)'
        type: string
        default: 'bug fix, improvement, refacto, new feature'

jobs:
  validate:
    name: Validate PR Metadata
    runs-on: ubuntu-latest
    steps:
      - name: Check PR Metadata
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title;
            const body = pr.body || "";
            const author = pr.user.login;
            const milestone = pr.milestone ? pr.milestone.title : "";

            const ACCEPTED_CATEGORIES = '${{ inputs.accepted_categories }}'.split(',').map(s => s.trim().toUpperCase());
            const ACCEPTED_TYPES = '${{ inputs.accepted_types }}'.split(',').map(s => s.trim().toLowerCase());
            const BUMP_PR_AUTHOR = ['dependabot[bot]', 'github-actions[bot]', '@github-actions[bot]'];
            const BUMP_PR_TITLE_PREFIX = 'Bump';

            function isBumpPullRequest(title, author) {
              return title.startsWith(BUMP_PR_TITLE_PREFIX) && BUMP_PR_AUTHOR.includes(author);
            }

            if (isBumpPullRequest(title, author)) {
              console.log("Bump PR detected. Skipping manual metadata validation.");
              return;
            }

            const errors = [];

            // Helper to build pattern
            function buildPattern(propertyName, captureGroup) {
              return new RegExp('^(?:\s*\|?\s*)' + propertyName + '\??\s*\|\s*(' + captureGroup + ')(?:\s*\|?\s*)$', 'im');
            }

            // Extract Category
            const categoryMatch = body.match(buildPattern('Category', '[a-z]{2}'));
            const category = categoryMatch ? categoryMatch[1].trim().toUpperCase() : "";
            if (!ACCEPTED_CATEGORIES.includes(category)) {
              errors.push(`Invalid category: "${category}". Expected one of: ${ACCEPTED_CATEGORIES.join(', ')}`);
            }

            // Extract Type
            const typeMatch = body.match(buildPattern('Type', '[a-zA-Z\s]+'));
            const type = typeMatch ? typeMatch[1].trim().toLowerCase() : "";
            if (!ACCEPTED_TYPES.includes(type)) {
              errors.push(`Invalid type: "${type}". Expected one of: ${ACCEPTED_TYPES.join(', ')}`);
            }

            // Validate Title
            if (!/^[A-Z]/.test(title)) {
              errors.push('Pull Request title does not start with an uppercase letter');
            }

            // Validate Milestone
            if (!milestone) {
              errors.push('No milestone defined');
            }

            if (errors.length > 0) {
              core.setFailed("PR validation failed:\n- " + errors.join('\n- '));
            } else {
              console.log("PR validation successful!");
            }

