name: PR Metadata Validator
on:
  workflow_call:
    inputs:
      accepted_categories:
        description: 'List of accepted categories (comma-separated)'
        type: string
        default: 'FO, CO, BO, WS, IN, TE, LO, ME, PM'
      accepted_types:
        description: 'List of accepted types (comma-separated)'
        type: string
        default: 'bug fix, improvement, refacto, new feature'

jobs:
  validate:
    name: Validate PR Metadata
    runs-on: ubuntu-latest
    steps:
      - name: Check PR Metadata
        uses: actions/github-script@v7
        env:
          # Pass inputs via env for added safety
          ACCEPTED_CATEGORIES: ${{ inputs.accepted_categories }}
          ACCEPTED_TYPES: ${{ inputs.accepted_types }}
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title;
            const body = pr.body || "";
            const author = pr.user.login;
            const milestone = pr.milestone ? pr.milestone.title : "";

            const categories = process.env.ACCEPTED_CATEGORIES.split(',').map(s => s.trim().toUpperCase());
            const types = process.env.ACCEPTED_TYPES.split(',').map(s => s.trim().toLowerCase());
            
            const BUMP_PR_AUTHOR = ['dependabot[bot]', 'github-actions[bot]'];
            const BUMP_PR_TITLE_PREFIX = 'Bump';

            if (title.startsWith(BUMP_PR_TITLE_PREFIX) && BUMP_PR_AUTHOR.includes(author)) {
              console.log("Bump PR detected. Skipping validation.");
              return;
            }

            const errors = [];

            // Helper to build pattern
            function buildPattern(propertyName, captureGroup) {
              // Supports formats: "| Category | FO |" or "Category: FO"
              return new RegExp('^\\s*\\|?\\s*' + propertyName + '\\??\\s*[|:]\\s*(' + captureGroup + ')\\s*\\|?\\s*$', 'im');
            }

            // Category validation
            const categoryMatch = body.match(buildPattern('Category', '[a-zA-Z]{2}'));
            const category = categoryMatch ? categoryMatch[1].trim().toUpperCase() : "";
            if (!categories.includes(category)) {
              errors.push(`Invalid category: "${category}". Expected one of: ${categories.join(', ')}`);
            }

            // Type validation
            const typeMatch = body.match(buildPattern('Type', '[a-zA-Z\\s]+'));
            const type = typeMatch ? typeMatch[1].trim().toLowerCase() : "";
            if (!types.includes(type)) {
              errors.push(`Invalid type: "${type}". Expected one of: ${types.join(', ')}`);
            }

            // Title validation (must start with uppercase)
            if (!/^[A-Z]/.test(title)) {
              errors.push('Pull Request title must start with an uppercase letter');
            }

            // Milestone validation
            if (!milestone) {
              errors.push('No milestone defined for this Pull Request');
            }

            if (errors.length > 0) {
              core.setFailed("PR validation failed:\n- " + errors.join('\n- '));
            } else {
              console.log("PR validation successful!");
            }
              